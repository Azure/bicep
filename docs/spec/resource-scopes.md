# Resource Scopes
> **Note:** Not implemented yet.

## Introduction / Motivation
A deployment in ARM has an associated scope, which dictates the scope that resources within that deployment are created in. There are various ways to deploy resources across multiple scopes today in ARM templates; this spec describes how similar functionality can be achieved in Bicep.

See [here][arm-scopes] for more information on ARM scopes.

## Declaring and using scopes

### Declaring the target scope(s)
Unless otherwise specified, Bicep will assume that a given `.bicep` file is to be deployed at a resource group scope, and will validate resources accordingly. If you wish to change this scope, or define a file that can be deployed at multiple scopes, you must use the `target` keyword with either a string or array value as follows:

```bicep
// this file can only be deployed at a subscription scope
target = 'subscription'
```

```bicep
// this file can be deployed at either a tenant or managementGroup scope
target = [
  'tenant'
  'managementGroup'
]
```

The following strings are permitted for the `target` keyword: `'tenant'`, `'managementGroup'`, `'subscription'`, `'resourceGroup'`. Expressions are not permitted.

It is important to set the target scope because it allows Bicep to perform validation that the resources declared in the `.bicep` file are permitted at that scope, and it also ensures that the correct type of scope is passed to the module when the module is referenced.

### Additional 'resourceId' Type
With the implementation of this feature, we introduce a new type `resourceId` (subtype of `string`). This type contains structured information about a resource identifier or scope, but with a string representation. We will allow `resourceId` to be assigned to a `string`, but not a `string` to be assigned to a `resourceId`.

### Resource 'id' Property
The existing readonly resource property `id` will be updated to return a `resourceId` type rather than a `string`. This will be a non-breaking change because we will allow assignment to `string` as discussed in [Additional 'resourceId' Type](#additional-resourceid-type).

### Resource or Module 'scope' Property
An additional optional read-write property `scope` of type `resourceId` will be added to the `resource` & `module` types.

Assigning a scope to this field indicates that the resource or module must be deployed at that scope. If the field is not provided, the resource or module will be deployed at the target scope for the file (see [Declaring the target scope(s)](#declaring-the-target-scopes)).

```bicep
resource myNic 'Microsoft.Network/networkInterfaces@2020-01-01' = {
  // use a different resource group scope for this resource
  scope: scope.resourceGroup(myExternalResourceGroup)
}

module myModule './path/to/module.bicep' = {
  name: 'myModule'
  // deploy this module at the subscription scope
  scope: scope.subscription()
}
```

If the scope being assigned has been generated by another resource (for example the deployment of a resourceGroup), using this scope will set up an implicit dependency from child on parent.

### Global Functions
We will introduce an object named `scope` under the `az` namespaces, with the following methods, which will all return scopes of type `resourceId`:

```bicep
scope.tenant() // returns the tenant scope
  
scope.managementGroup(name: string) // returns a named management scope

scope.subscription() // returns the subscription scope for the current deployment
scope.subscription(subscriptionId: string) // returns a named subscription scope

scope.resourceGroup() // returns the resource group scope for the current deployment
scope.resourceGroup(resourceGroupName: string) // returns a named resource group scope for a group in the same subscription
scope.resourceGroup(resourceGroupName: string, subscription: string)  // returns a named resource group scope

scope.extension(resourceId: string) // returns an extension scope for a given resourceId (external resource)
```

### Type checking
Internally, we will store the information about the type of the `resourceId` - this can be `TenantScope`, `ManagementGroupScope`, `SubscriptionScope`, `ResourceGroupScope` and `ExtensionScope`, allowing for combinations.

Bicep will use this information to verify that the scope type being passed to a resource or module matches an acceptable type or set of types for that resource or module.

## Example Usages
```bicep
// deploy a resource group to the subscription scope
resource myRg 'Microsoft.Resources/resourceGroups@2020-01-01 = {
  name: 'myRg'
  location: 'West US'
  scope: scope.subscription()
}

// deploy a resource into the newly-created resource group
resource myNic 'Microsoft.Network/networkInterfaces@2020-01-01 = {
  name: 'myNic'
  location: 'West US'
  scope: myRg.id // use the scope of the newly-created resource group
}

// deploy an extension resource on the network interface
resource extension 'Microsoft.MockExtension/extension@2020-01-01 = {
  name: 'myExtension'
  scope: myNic.id // use the scope of the network interface to deploy the extension resource
}
```

## Allowed combinations of scopes
This feature will be limited to the same scoping constraints that exist within ARM Deployments today. We will prevent successful compilation of a template that cannot be deployed, with an error message explaining the constraint.

## Possible Extensions

### Parent-child syntax
We may want to use a similar concept to deploy child resources of a parent in a less-verbose manner - e.g.:
```bicep
resource myParent 'My.Rp/parentType@2020-01-01' = {
  name: 'myParent'
  location: 'West US'
}

resource myChild 'My.Rp/parentType/childType@2020-01-01' = {
  parent: myParent.id // pass parent resourceId
  name: 'myChild' // don't require the full name to be formatted with '/' characters
}
```

[arm-scopes]: https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/overview#understand-scope
