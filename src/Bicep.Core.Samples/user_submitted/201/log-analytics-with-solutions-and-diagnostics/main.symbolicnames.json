{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "1.9-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
    "_generator": {
      "name": "bicep",
      "version": "dev",
      "templateHash": "7479514119272576374"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "defaultValue": "[format('la-{0}', uniqueString(resourceGroup().id))]"
    }
  },
  "variables": {
    "vmInsights": {
      "name": "[format('VMInsights({0})', parameters('logAnalyticsWorkspaceName'))]",
      "galleryName": "VMInsights"
    },
    "containerInsights": {
      "name": "[format('ContainerInsights({0})', parameters('logAnalyticsWorkspaceName'))]",
      "galleryName": "ContainerInsights"
    },
    "environmentName": "Production",
    "costCenterName": "IT"
  },
  "resources": {
    "logAnalyticsWorkspace": {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-03-01-preview",
      "name": "[parameters('logAnalyticsWorkspaceName')]",
      "location": "[parameters('location')]",
      "tags": {
        "Environment": "[variables('environmentName')]",
        "CostCenter": "[variables('costCenterName')]"
      },
      "properties": {
        "retentionInDays": 30,
        "features": {
          "searchVersion": 1
        },
        "sku": {
          "name": "PerGB2018"
        }
      }
    },
    "logAnalyticsWorkspaceDiagnostics": {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2017-05-01-preview",
      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', parameters('logAnalyticsWorkspaceName'))]",
      "name": "diagnosticSettings",
      "properties": {
        "workspaceId": "[resourceInfo('logAnalyticsWorkspace').id]",
        "logs": [
          {
            "category": "Audit",
            "enabled": true,
            "retentionPolicy": {
              "days": 7,
              "enabled": true
            }
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true,
            "retentionPolicy": {
              "days": 7,
              "enabled": true
            }
          }
        ]
      },
      "dependsOn": [
        "logAnalyticsWorkspace"
      ]
    },
    "solutionsVMInsights": {
      "type": "Microsoft.OperationsManagement/solutions",
      "apiVersion": "2015-11-01-preview",
      "name": "[variables('vmInsights').name]",
      "location": "[parameters('location')]",
      "properties": {
        "workspaceResourceId": "[resourceInfo('logAnalyticsWorkspace').id]"
      },
      "plan": {
        "name": "[variables('vmInsights').name]",
        "publisher": "Microsoft",
        "product": "[format('OMSGallery/{0}', variables('vmInsights').galleryName)]",
        "promotionCode": ""
      },
      "dependsOn": [
        "logAnalyticsWorkspace"
      ]
    },
    "solutionsContainerInsights": {
      "type": "Microsoft.OperationsManagement/solutions",
      "apiVersion": "2015-11-01-preview",
      "name": "[variables('containerInsights').name]",
      "location": "[parameters('location')]",
      "properties": {
        "workspaceResourceId": "[resourceInfo('logAnalyticsWorkspace').id]"
      },
      "plan": {
        "name": "[variables('containerInsights').name]",
        "publisher": "Microsoft",
        "product": "[format('OMSGallery/{0}', variables('containerInsights').galleryName)]",
        "promotionCode": ""
      },
      "dependsOn": [
        "logAnalyticsWorkspace"
      ]
    }
  }
}